%=====================================================================================
%
%       Filename:  figure_3.tex
%
%    Description:  Multiple bistables in PSD synchronized by subunit exchange.
%
%        Version:  1.0
%        Created:  Friday 12 January 2018
%       Revision:  none
%
%         Author:  Dilawar Singh (), dilawars@ncbs.res.in
%   Organization:  NCBS Bangalore
%      Copyright:  Copyright (c) 2018, Dilawar Singh
%
%          Notes:  
%
%=====================================================================================

\RequirePackage{luatex85,shellesc}
\documentclass[crop=true,multi=false,varwidth=17.8cm,class=../pnas-new]{standalone}
\usepackage{amsmath,amssymb}
\usepackage{pgfplots}
\usepackage{xstring}
\usepackage{xcolor}
\usepackage{siunitx}
\usepackage{tabularx}
\usepackage[small]{eulervm}
\setboolean{displaywatermark}{false}

% Cokumntype P has fixed width and align to left as well. See 
% https://tex.stackexchange.com/a/7348/8087 
\usepackage{array}
\usepackage{ragged2e}
\newcolumntype{P}[1]{>{\raggedright\arraybackslash}p{#1}}
\renewcommand\familydefault{\sfdefault}
\pgfplotsset{compat=newest}
\usetikzlibrary{calc,positioning}
\usetikzlibrary{shapes,arrows,arrows.meta,fit}

\usepgfplotslibrary{patchplots}
\usepgfplotslibrary{units}
\usepackage{xifthen} % provides isempty
\input{macros}

\begin{document}

\edef\figH{10.0}
\edef\HEIGHT{35mm}
\pgfmathsetmacro{\figW}{17.8}
\pgfmathsetmacro{\colW}{0.5*\figW}
\pgfmathsetmacro{\plotW}{0.9*\colW}
\pgfmathsetmacro{\plotH}{3}
\def\PSDLENGTH{\plotW}
\pgfplotsset{axis lines=left}
\pgfplotsset{legend style={fill=none,draw=none}}

\pgfplotsset{
    , xtick align=center
    , ytick align=center
    , unit markings=parenthesis
    , legend style={fill=none,draw=none,font=\footnotesize}
    , xticklabel style={/pgf/number format/fixed}
    , yticklabel style={/pgf/number format/fixed}
    , tick label style={font=\scriptsize}
    , axis line style={-}
    , label style={font=\small}
    , colorbar style={width=2mm,samples=3,draw=none,xshift=-3mm}
    , ylabel shift=-1mm
}

% label macro
\newcommand\LABEL[2]{\node[above left=of #1.north west,xshift=5mm,yshift=-5mm]{\bf #2};}

% macro for plotting trajectories and its histogram.
\newcommand\PlotTrajWithHist[6]{ %name,location,filename,every,color,extra
    \edef\plotH{3}
    \begin{axis}[name=#1,at={#2},anchor=north west
        , width=0.9*\plotW cm, height=\plotH cm 
        , ytick={0,6,12,18}
        , enlarge y limits
        , ylabel style={align=left}
        , ylabel={CaMKII$^*$}
        , ymin = 0
        , title style={at={(0.5,0.75)}}
        ,#6
        ]
        \addplot [color=#5] gnuplot [ raw gnuplot, id=#1fig21 ] { 
            plot "#3" every #4 using (column("time")/86400):"CaMKII*"; 
        };
    \end{axis}
    \begin{axis}[
        , enlargelimits
        , height=\plotH cm, width=0.8*\plotH cm
        , ytick=\empty
        , at = (#1.north east), xshift=2mm
        , anchor = north west
        , x filter/.code=\pgfmathparse{rawy}
        , y filter/.code=\pgfmathparse{rawx}
        , try min ticks=2
        , scaled ticks=false
        , title style={font=\scriptsize,at={(0.5,0.75)}}
        , ymin = 0
        ]
        \addplot [fill=#5,xbar, draw=#5, bar width=0.5mm] gnuplot [ raw gnuplot,id=#1fig ] 
        {
            stats "#3" using "CaMKII*" prefix "A";
            bin(x,width)=width*floor(x/width);
            plot "#3" using (bin(column("CaMKII*"),1)):(1.0/A_sum) smooth freq;
        };
    \end{axis}
}


% Controls the stretch in which free subunits are drawn.
\pgfmathsetmacro{\fW}{0.95*\plotW}
% Controls the size of subunits.
\edef\SUSIZE{0.12}

\begin{tabularx}{\textwidth}{p{\colW cm} p{\colW cm}}
    % row 1 column 1
    \begin{tikzpicture}[baseline]
        \foreach \j in {1,...,18}
        {
            \edef\activeSE{1,3,random(1,7),random(1,7),random(1,7),random(1,7),random(1,7)}
            % Each switch has some camkii here.
            \pgfmathsetmacro{\xpos}{(\j-10)*\fW/20}
            \coordinate (pos\j) at (\xpos, 0.3*rand);
            \pgfmathsetmacro{\NumberOfSuInRing}{6}
            \CAMKII{c\j}{pos\j}{\activeSE}{\SUSIZE}{\NumberOfSuInRing};
        }

        \foreach \j in {1,2,...,18}
        {
            \node[shade,ball color=red, fill=red, circle, minimum size=\SUSIZE cm
                ,inner sep=1pt] (su\j) at (\fW/2*rand,0.8*rand) { };
            \pgfmathsetmacro{\Ang}{(rand>0)?0:180}
            \draw[-latex,color=red] (su\j) -- ++(\Ang:3mm);

            \node[shade,ball color=blue,fill=blue,circle,minimum size=\SUSIZE cm
                ,inner sep=1pt] (su\j) at (\fW/2*rand,0.8*rand) { };
            \pgfmathsetmacro{\Ang}{(rand>0)?0:180}
            \draw[-latex,color=blue] (su\j) -- ++(\Ang:3mm);
        }

        %% Draw PSD over switches.
        \node[cylinder, minimum width=18mm, minimum height=0.95*\plotW cm
           , draw=blue, fill=blue!50, opacity=0.1, inner sep=1mm
           ] (psd) at (0,0) { };
        
       \node[xshift=-1mm,above=of psd.bottom] (labela) {\bf A};

        % K distance away from each other.
        \draw[|<->|,thick] let \p{r1}=(pos1), \p{r2}=(pos2), \p{y0}=(psd.south)
           in  (\x{r1},\y{y0}) -- (\x{r2},\y{y0}) node[below,midway] {d};
    \end{tikzpicture} 
    & 
    % row 1 column 2
    \begin{tikzpicture}[baseline]
        % Draw camkii rings.
        \foreach \i/\x in {-2/1,0/2,2/3}
        {
            \node[draw=red, dotted, thick, circle, minimum size=15mm 
                , label={[node distance=3mm]above:{\small Cluster \x}}
                ] (switch\x)  at (\i,0) { };

            \foreach \j in {1,...,6}
            {
                \edef\activeSE{random(1,7),random(1,7),random(1,7)
                    ,random(1,7),random(1,7),random(1,7),random(1,7)}
                % Each switch has some camkii here.
                \coordinate (camkii0) at (\i+0.4*rand,0.6*rand);
                \begin{scope}[rotate=30*rand]
                    \pgfmathsetmacro{\NumberOfSuInRing}{random(6,7)}
                    \CAMKII{c0}{camkii0}{\activeSE}{\SUSIZE}{\NumberOfSuInRing};
                \end{scope}
            }
        }

        % K distance away from each other.
        \draw[|<->|,thick] let \p{r1}=(switch1), \p{r2}=(switch2), \p{y0}=(psd.south)
           in  (\x{r1},\y{y0}) -- (\x{r2},\y{y0}) node[below,midway] {d};

        \foreach \j in {1,2,...,9}
        {
            \node[shade,ball color=red, fill=red, circle
                , minimum size=\SUSIZE cm ,inner sep=1pt] (su\j) 
                at (\fW/2*rand,0.8*rand) {};
            \pgfmathsetmacro{\Ang}{(rand>0)?0:180}
            \draw[-latex,color=red] (su\j) -- ++(\Ang:3mm);
        }

        \foreach \j in {1,2,...,9}
        {
            \node[shade,ball color=blue,fill=blue,circle,minimum size=\SUSIZE cm
            ,inner sep=1pt] (su\j) at (\fW/2*rand,0.8*rand) { };
            \pgfmathsetmacro{\Ang}{(rand>0)?0:180}
            \draw[-latex,color=blue] (su\j) -- ++(\Ang:3mm);
        }
        % Draw PSD over switches.
        \node[cylinder, minimum width=18mm, minimum height=0.95*\plotW cm
        , draw=blue, fill=blue!50, opacity=0.1, inner sep=1mm
        ] (psd) at (switch2) { };
       \node[xshift=-1mm,above=of psd.bottom] (labeld) {\bf D};
    \end{tikzpicture} 
    \\ 
    % row 2 column 1
    \begin{tikzpicture}[scale=1 , every node/.style={} ]
        \PlotTrajWithHist{uniformA}{(0,0)}{CaM-18+PP-1000+N-18+L-10e-9+SU-OFF.dat_processed.dat}{1}{red}{%
            title={-SE, \quad d=\SI{30}{\nano\meter}}
        }
        \LABEL{uniformA}{B}
        \PlotTrajWithHist{uniformB}{(uniformA.below south west)}{%
            CaMKII-18+PP1-1500+D-1e-13+SU-ON+N-18.dat_processed.dat}{1}{blue}{%
            xlabel=Time,x unit=day
            , title={+SE,\quad D=\SI{e-13}{\m^2\per\second},\quad d=\SI{30}{\nano\meter}}
            , yshift=-2mm
        }
    \end{tikzpicture} 
    &
    % row 2 column 2
    \begin{tikzpicture}[scale=1, every node/.style={} ]
        \PlotTrajWithHist{without_su_axis}{(0,0)}{%
            ./CaMKII-6+PP1-27+L-125e-9+N-3+diff-0.dat_processed.dat}{%
            20}{red}{title=-SE}
        \LABEL{without_su_axis}{E}
        \PlotTrajWithHist{with_su_axis}{(without_su_axis.below south west)}{%
            ./CaMKII-6+PP1-27+L-125e-9+N-3+diff-1e-12.dat_processed.dat}{20}{blue}{%
                xlabel=Time, x unit=day
                , title={+SE,D=\SI{e-12}{\meter\squared\per\second}}
                , yshift=-2mm
        }
    \end{tikzpicture} 
    \\
    % row 3 column 1
    \pgfplotsset{axis lines*=box}
    \begin{tikzpicture}[scale=1]
        \begin{semilogxaxis}[name=c1
            , axis lines*=left
            , xlabel= $D$
            , ylabel={Avg CaMKII\textsubscript{*}}
            , x unit=\si{\meter \squared \per \second}
            , height=\HEIGHT
            , ytick={0,6,12,18}
            , xtick={1e-15,1e-13}
            , enlargelimits
            , legend style={fill=none,at={(0.5,0)},anchor=south west}
            , legend columns=1
            , title={d=\SI{30}{\nano\meter}}
            , ymin=0, ymax=18
            ]
            \addplot+ [error bars/.cd, y dir=both,y explicit] table 
                [col sep=comma,x=D, y=Mean CaMKII, y error=Std CaMKII]{su_spread_activation_n9.csv};
            \addplot+ [error bars/.cd, y dir=both,y explicit] table 
                [col sep=comma,x=D, y=Mean CaMKII, y error=Std CaMKII]{su_spread_activation_n18.csv};
            \legend{\scriptsize N\textsubscript{v}=9,\scriptsize N\textsubscript{v}=18}
        \end{semilogxaxis}
        \LABEL{c1}{C}
        \begin{semilogxaxis}[ 
            name=c2, at={(c1.south east)}, anchor=south west, xshift=12mm
            , view={0}{90}
            , xlabel= $D$
            , x unit=\si{\meter \squared \per \second}
            , xtick={1e-15,1e-13}
            , ytick={3,2,1}
            , ylabel = {\#CaMKII/voxel}
            , title={Avg CaMKII\textsuperscript{*}} 
            , height=\HEIGHT
            , colorbar
            , enlargelimits
            ]
            \addplot3 [surf, mesh/cols=10, shader=interp,patch type=bilinear] 
                table[y expr={18/\thisrow{N}}]{su_spread_activation_contour.csv};
        \end{semilogxaxis}
    \end{tikzpicture}
    & 
    % row 3 column 2
    \pgfplotsset{axis lines*=box}
    \begin{tikzpicture}[scale=1]
        \begin{semilogxaxis}[name=f1
            , axis lines*=left
            , xlabel= $D$
            , x unit=\si{\meter \squared \per \second}
            , height=\HEIGHT
            , enlargelimits
            , legend style={fill=none,at={(0,0.8)},anchor=south west}
            , legend columns=-1
            , ymax = 1, ymin = 0
            , title={d=\SI{30}{\nano\meter}}
            ]
            \addplot+ [color=blue] gnuplot [raw gnuplot] {
                set datafile separator ",";
                plot "./decay_of_intermediate_states.dat" u 
                "diff const":"intermediate states mean";
            };
            \addplot+ [color=red] gnuplot [raw gnuplot] {
                set datafile separator ",";
                plot "./decay_of_intermediate_states.dat" u 
                    "diff const":(1-column("intermediate states mean"));
            };
            \legend{$t_{i}$, $k_{s}$ };
        \end{semilogxaxis}
        \LABEL{f1}{F}
        \begin{semilogxaxis}[name=f2
            , at={(f1.south east)}, anchor=south west, xshift=12mm
            , view={0}{90}
            , xlabel= $D$
            , x unit=\si{\meter \squared \per \second}
            , title={$k_{s}$} 
            , height=\HEIGHT
            , colorbar
            , enlargelimits
            , ylabel = d, y unit= \si{\meter}
            , scaled y ticks=base 10:9
            , ylabel shift=-2mm
            ]
            \addplot3 [surf,mesh/rows=10,shader=interp] table[col sep=comma
            , z expr={1-\thisrow{intermediate_state}}
            ] {./data_sync_phase_plot.csv};
        \end{semilogxaxis}
    \end{tikzpicture}
\end{tabularx}
\end{document}
