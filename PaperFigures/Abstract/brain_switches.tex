\RequirePackage{luatex85,shellesc}
\documentclass[tikz,multi=false]{standalone}
\usepackage{pgfplots}
\usepackage{ifthen}
\usepackage{xstring}
\usetikzlibrary{arrows,arrows.meta}
\usetikzlibrary{calc,positioning,fit,shapes}
\usepackage[sfdefault]{FiraSans}
\usepackage{eulervm}
\usepackage{circuitikzgit}


\begin{document}

\input{../macros}

\newcommand\SWITCH[6]{ % name, x, y, width, rotation, on-off
    \edef\y{0.2}
    \ifthenelse{#6=1}{\edef\y{0.1}}{}
    \begin{scope}[xshift=-#2, yshift=-#3, rotate=#5]
        \draw[-Circle,line width=#4] (0 cm,0 cm) node (#1_a) {} -- (1 cm,0);
        \draw[Circle-,line width=#4] (1.5 cm,0) -- (2.5 cm,0) node (#1_b) {};
        \draw[line width=#4] (1 cm,\y cm) -- (1.5 cm,\y cm);
        \draw[line width=#4] (1.25 cm,\y cm) -- ++(0,0.2 cm);
    \end{scope}
}

\begin{tikzpicture}[scale=1]
    \node (synapse)  at (0,0)
    {
        \begin{tikzpicture}[scale=0.75, rotate=-45, every node/.style={} ]
            % Draw synapse. Pre synaptic side.
            \begin{scope}[rotate=-90]
                \draw[color=red!30,very thick, fill=red!10] plot[smooth] coordinates { 
                    (-3,-5) (-3,-4) (-6,-2) (-7,1) 
                    (0,1) (3,1) (2.5,-2) (-1,-4) 
                    (-1,-5) 
                };
            \end{scope}

            % Post synaptic side.
            \begin{scope}[yshift=4.3cm, xshift=2.75cm, rotate=90]
                \draw[color=red!40, very thick, fill=red!15] plot[smooth] coordinates { 
                    (-3,-8) (-3,-4) (-7,-2) (-7,1) 
                    (0,1) (2,1) (3,1) (2.5,-3.1) 
                    (-1,-3.5) (-1,-8) 
                };
                % PSD
                \draw[draw=black, dashed, fill=red!30] plot[smooth] coordinates { 
                    (-6.5,0) (-6.3,1.1) (0,1.05) (2,1) (2.5,1) (2,0) (-4,0.5) (-6.5,0)
                };
            \end{scope}

            % switches
            \edef\CLR{blue!80}
            \foreach[count=\i] \y in {-1.5,2.25,6}
            {
                \pgfmathsetmacro{\LW}{1+rnd}
                \pgfmathsetmacro{\AA}{rnd}
                \ifdim\AA pt<0.4pt
                    \ctikzset{bipoles/pushbutton/height=1}
                    \draw[line width=\LW pt, \CLR, smooth] (2,\y) -- (2.5,\y) 
                        to[push button, color=blue] (4,\y);
                \else
                    \ctikzset{bipoles/pushbutton/height=0.5}
                    \draw[line width=\LW pt, \CLR, smooth] (2,\y) -- (2.5,\y) 
                        to[push button, color=blue] (4,\y);
                \fi

                \draw[{Arc Barb[reversed,width=5mm,length=1mm]}-,line width=\LW pt, \CLR] (1.8,\y) -- (2,\y);

                % path.
                \pgfmathsetmacro\ynew{2.25+(\i-2)}
                \draw[color=\CLR, thick ] plot[smooth] coordinates {
                    (4,\y) (5,\ynew) (6,2+0.1*\y) 
                };
            }

            \edef\y{0}
            \draw[color=\CLR, very thick,dashed] (4,\y) node[ circle, draw, left, dotted]
            {$\int$} to[bend left] (6,2+0.1*\y);

            \edef\y{4.5}
            \draw[color=\CLR, very thick,dashed] (4,\y) node[circle,draw,left,dotted]
                {$\int$} to[bend right] (6,2+0.1*\y);


            % Add all
            \node[fill=blue!10,circle,draw=blue] (int) at (6.25,2.25) {\Huge $\sum$};

            % Pre synaptic side fill-in.
            \tikzset{every path/.style={line width=3pt,dashed}}
            \tikzset{pre/.style={-{o[width=5pt]},very thick}}

            \foreach[count=\i] \j in {-5,-4,...,5}
            {
                \draw[pre,color=blue!20] plot[smooth] coordinates { 
                    (-5+0.1*rnd,1.4+0.1*\i) 
                    (-4+0.1*rnd,1.15+0.15*\i)
                    (-3+0.1*rnd,-1.5+0.5*\i)
                    (-2+0.1*rnd,-2.5+0.75*\i)
                    (-1+0.1*rnd,-3+0.85*\i)
                    (0+0.1*rnd,-3.3+0.9*\i)
                    (1+0.1*rnd,-3.4+0.9*\i)
                };
            }
        \end{tikzpicture}	
    };

    \edef\CylWidth{2}
    \edef\SUSIZE{0.15}
    \edef\figW{12}
    \edef\fW{12}

    \node (psd) [xshift=10cm, yshift=3cm]
    {
        % PSD in cylinder with diffusion.
        \begin{tikzpicture}[baseline]
            % Draw camkii rings.
            \foreach \i/\x in {-4/1, 0/2, 4/3}
            {
                \node[ draw=red, dotted, thick, circle
                    , minimum size=\CylWidth cm] (switch\x)  at (\i,0) { };

                \foreach \j in {1,...,6}
                {
                    \edef\activeSE{random(1,7),random(1,7),random(1,7)
                    ,random(1,7),random(1,7),random(1,7),random(1,7)}
                    % Each switch has some camkii here.
                    \coordinate (camkii0) at (\i+0.4*rand,0.3*\CylWidth*rand);
                    \begin{scope}[rotate=30*rand]
                        \pgfmathsetmacro{\NumberOfSuInRing}{random(6,7)}
                        \CAMKIIWithoutHub{c0}{camkii0}{\activeSE}{\SUSIZE}{\NumberOfSuInRing};
                    \end{scope}
                }
            }

            % Draw PSD over switches.
            \node[cylinder, minimum width=\CylWidth cm, minimum height=\figW cm
            , draw=black, dashed, fill=red, opacity=0.2, inner sep=1mm
            ] (psd) at (switch2) {};

            \foreach \j in {1,2,...,9}
            {
                \node[shade,ball color=red, fill=red, circle
                    , minimum size=\SUSIZE cm ,inner sep=1pt] (su\j) 
                    at (\fW/2.1*rand,0.4*\CylWidth*rand) {};
                \pgfmathsetmacro{\Ang}{(rand>0)?0:180}
                \draw[-latex,color=red,very thin] (su\j) -- ++(\Ang:3mm);
            }

            \foreach \j in {1,2,...,9}
            {
                \node[shade, ball color=blue, fill=blue, circle, minimum size=\SUSIZE cm, inner sep=1pt] 
                    (su\j) at (\fW/2.1*rand,0.4*\CylWidth*rand) { };
                \pgfmathsetmacro{\Ang}{(rand>0)?0:180}
                \draw[-latex,color=blue,very thin] (su\j) -- ++(\Ang:3mm);
            }

        \end{tikzpicture} 
    };

    % Bistable trajectory.
    \node[below=2cm of psd, xshift=0cm, yshift=0cm] (bistable) 
    {
        \begin{tikzpicture}[scale=1]
            \begin{axis}[
                xlabel=Time (year), ylabel={$\Sigma$}
                , ylabel style={font=\Large}
                , width=0.75*\figW cm, height=\CylWidth cm, scale only axis
                , ytick={0,18}
                , yticklabels={\texttt{OFF},\texttt{ON}}
                , axis lines*=left
                , xmin=0, xmax=6
                ]
                \addplot [color=blue] gnuplot [ raw gnuplot ] {
                    plot
                    "../elifeFigure5/CaMKII-6+PP1-27+L-125e-9+N-3+diff-1e-12.dat_processed.dat"
                    using (column("time")/3600/365):"CaMKII*" every 10;
                };
            \end{axis}

            %\ctikzset{bipoles/pushbutton/height=1}
            %\path[very thick] (-1.5,0.5) to[push button] ++(0.5,0);

            %\ctikzset{bipoles/pushbutton/height=0.5}
            %\path[very thick] (-1.5,2) to[push button] ++(0.5,0);
        \end{tikzpicture}
    };

    % draw arrow from synapse to PSD.
    \draw[-latex, red, very thick] ($(synapse.center)+(2.5,2.5)$) to[bend left] (psd.west);

\end{tikzpicture}	
\end{document}

