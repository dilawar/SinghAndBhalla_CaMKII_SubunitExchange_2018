% IMP NOTE: Monday 09 July 2018 05:34:36 PM IST.
% - In data, what I call Dxy has been replaced by Dsub in text.
% CaMKII activation spread due to SU.
\RequirePackage{luatex85,shellesc}
\documentclass[varwidth=87mm,class=../pnas-new]{standalone}
\usepackage{tikz}
\usepackage{tabularx}
\usetikzlibrary{arrows,arrows.meta}
\usepackage{siunitx}
\usepackage{pgfplots}
\renewcommand{\familydefault}{\sfdefault}

\usepgfplotslibrary{units}
\usetikzlibrary{calc,positioning,fit,shapes}

%\usetikzlibrary{external}
%\tikzset{external/system call={lualatex -shell-escape -jobname "\image" "\texsource"}}
%\tikzexternalize

\usepackage{xstring}
\input{macros}

\newcommand\ReplaceStr[1]{%
  \IfSubStr{#1}{1e}{%
    \StrSubstitute{#1}{1e}{e}}{#1}
}

\newcommand\SUB[2]{#1\textsubscript{#2}}
\newcommand\SUP[2]{#1\textsuperscript{#2}}

\begin{document}

\pgfplotsset{
    , compat=1.15
    , xtick align=center
    , ytick align=center
    , unit markings=parenthesis
    , legend style={fill=none,draw=none,font=\footnotesize,align=left}
    , label style={font=\footnotesize}
    , tick label style={font=\footnotesize}
    , axis lines=left
    , enlargelimits=true
    , unbounded coords=discard   % silently ignore points
    , filter discard warning=false
    , error bars/error bar style={opacity=0.3,}
    , axis line style={-}
    , legend cell align=left
}

\tikzset {
    every node/.style={inner sep=1pt}
}

% This is from https://tex.stackexchange.com/a/99328/8087
\newcounter{marknumber}
\pgfplotsset{
    error bars/every nth mark/.style={
        /pgfplots/error bars/draw error bar/.prefix code={
            \pgfmathtruncatemacro\marknumbercheck{mod(floor(\themarknumber/2),#1)}
            \ifnum\marknumbercheck=0
            \else
                \begin{scope}[opacity=0]
            \fi
        },
        /pgfplots/error bars/draw error bar/.append code={
            \ifnum\marknumbercheck=0
            \else
                \end{scope}
            \fi
            \stepcounter{marknumber}    
        }
    }
}

\pgfmathsetmacro{\figW}{8.7} 
\pgfmathsetmacro{\colW}{\figW/2}
\pgfmathsetmacro{\plotW}{0.95*\colW}
\def\plotH{3}

% Controls the stretch in which free subunits are drawn.
% Controls the size of subunits.
\edef\SUSIZE{0.1}
\edef\CylWidth{12}

\newcommand\CaMKIIInCylinder[3]{ %name, number, length in mm without unit
    % \draw (0,0) grid (10,1);
    \foreach \j in {1,...,#2}
    {
        \edef\activeSE{random(1,7),random(1,7),random(1,7),random(1,7),random(1,7)}
        % Each switch has some camkii here.
        \pgfmathsetmacro\HalfN{#2/100}
        \pgfmathsetmacro{\xpos}{\j*#3/#2}
        \coordinate (pos\j) at (\xpos mm, 0);
        \pgfmathsetmacro{\NumberOfSuInRing}{6}
        \CAMKIIWithoutHub{c\j}{pos\j}{\activeSE}{\SUSIZE}{\NumberOfSuInRing};
    }

    \foreach \j in {1,2,...,#2}
    {
        \pgfmathsetmacro{\Ang}{(rand>0)?0:180}

        \coordinate (su\j) at (#3 mm*0.95*rnd, 0.35*\CylWidth mm*rand);
        \node[shade,ball color=red, fill=red, circle
            , minimum size=\SUSIZE cm, inner sep=1pt] at (su\j) (ssu\j) {};

        \draw[-latex,very thin,color=red] (ssu\j) -- ++(\Ang:2mm);
        
        \coordinate (su\j) at (#3 mm*rnd, 0.35*\CylWidth mm*rand);
        \node[shade,ball color=blue,fill=blue,circle,minimum size=\SUSIZE cm
            ,inner sep=1pt] at (su\j) (ssu\j) {};

        \draw[-{Latex[width=1mm,length=1mm]}, thin, color=blue] (ssu\j) -- ++(\Ang:2mm);
    }

    % Draw PSD over switches.
    \node[cylinder, minimum width=\CylWidth mm, minimum height=0.85*\figW cm
           , draw=blue, fill=blue!50, opacity=0.2, inner sep=1mm
           ] (#1) at (#3 mm/2,0) { };
    
}

\newcommand\PlotTrace[3]{%filename, base label ca, label
    \begin{axis}[
        xlabel=Time, x unit=\si{\hour}
        , ylabel=Active CaMKII
        , width=\plotW cm, height=\plotH cm
        , legend style={at={(-0.1,0.95)}, anchor=south west, align=left}
        , legend columns = 1
        , ytick={0,6,12,18}
        , title = {Basal \SUP{Ca}{2+}=\SI{#2}{\nano M}}
        , title style={at={(0.5,2.1)}}
        , xmin=0, xmax=4
    ]
    \foreach \D/\Label in {0.0/0,1e-20/e-8,1e-15/e-3,1e-13/e-1}
    {
        \addplot+ [no marks
            , thick
            , each nth point={60}
            , error bars/.cd, y dir=both, y explicit, every nth mark=7
            ] table[ col sep=comma,
                , x expr={\thisrow{time}/3600}
                , y=mean_camkii_\D, y error=std_camkii_\D]
            {#1};

            \edef\temp{\noexpand\addlegendentry{
                D\noexpand\textsubscript{sub}=\SI{\Label}{\micro\meter\squared\per\second}}}\temp
    }
    % \addlegendentry{\si{m^2/s}}
    \end{axis}
    \node[ ] at  (current bounding box.north west) {\bf \normalsize #3};
}

\newcommand\AddSummaryPlot[2]{%filename, colkey
    \addplot+ [ mark options={mark size=1pt}
            , thick
            , error bars/.cd, y dir=both, y explicit
        ] table [col sep=comma
            , x expr=\thisrow{Dxy_#2NM}*1e12
            , y=mean_rise_time_#2NM
            , y error=std_rise_time_#2NM
        ]{#1};
        \edef\temp{\noexpand\addlegendentry{Ca\noexpand\textsuperscript{2+}=\SI{#2}{\nano M}}}\temp
}

\begin{tikzpicture}[scale=1]
    \CaMKIIInCylinder{cyl1}{18}{70}
    \node[left=of cyl1.west, yshift=10mm, xshift=10mm] {\bf \normalsize  A};
\end{tikzpicture} 

% \tikzset{external/force remake}

% table starts here.
\vspace{3mm}
\begin{tabular}{l l}
\begin{tikzpicture}[scale=1]
    \PlotTrace{./Data_ActivationSpread_ca80nm/mean_std_rise_time.csv}{80}{B}
\end{tikzpicture} &
\begin{tikzpicture}[scale=1]
    \PlotTrace{./Data_ActivationSpread_ca120nm/mean_std_rise_time.csv}{120}{C}
\end{tikzpicture} 
\\
\begin{tikzpicture}
    \begin{loglogaxis}[
        , xlabel=\SUB{D}{sub}
        , x unit=\si{\micro\meter\squared\per\second}
        , ylabel style={align=center}
        , ylabel = {Rise time\\ 10\% to 90\%}
        , y unit=\si{\hour}
        , width = \plotW cm
        , height = \plotH cm
        , legend style={at={(0,1)}, anchor=south west, anchor=south west}
        , legend columns=1
        , unbounded coords=jump
        , error bars/error bar style={opacity=0.9,}
        , extra x ticks={5e-3}
        , extra x tick labels={\SUB{D}{PP1}}
        , extra x tick style={grid=major
            , tick label style={rotate=90, anchor=east,}
        }
        ]
        % \AddSummaryPlot{./DATA_Activation_Spread/summary_rise_time.csv}{60}
        % \AddSummaryPlot{./DATA_Activation_Spread/summary_rise_time.csv}{70}
        \AddSummaryPlot{./DATA_Activation_Spread/summary_rise_time.csv}{80}
        \AddSummaryPlot{./DATA_Activation_Spread/summary_rise_time.csv}{90}
        \AddSummaryPlot{./DATA_Activation_Spread/summary_rise_time.csv}{100}
        \AddSummaryPlot{./DATA_Activation_Spread/summary_rise_time.csv}{120}
    \end{loglogaxis}
    \node[ ] at (current bounding box.north west) {\bf \normalsize D};
\end{tikzpicture}
&
\pgfplotsset{axis lines*=box}
\begin{tikzpicture}[]
    \begin{loglogaxis}[ name=c2
        % , at={(c1.south east)}, anchor=south west, xshift=12mm
        , view={0}{90}
        , xlabel= \SUB{D}{PP1}, x unit=\si{\micro\meter\squared\per\second}
        , xtick={1e-2,1e-1}
        , ytick={3,2,1}
        , ylabel = \SUB{D}{sub}, y unit=\si{\micro\meter\squared\per\second}
        , label style={font=\scriptsize}
        , title={Avg CaMKII\textsuperscript{*}, \SUB{N}{CaMKII}=6}
        , title style={at={(0.5,1.5)}, align=center}
        , width=0.9*\plotW cm
        , colorbar horizontal,
        , colorbar style={height=1.5mm, samples=3, at={(0,1.3)}, xticklabel pos=top }
        , enlargelimits=false
        , unbounded coords=jump
        , ytick={1e-2,1}
        , yticklabel style={rotate=90}
        ]
        \addplot3 [surf, mesh/cols=6] table 
            [col sep=comma
            , x expr=10^(\thisrow{Dpp1}+12)
            , y expr=10^(\thisrow{Dxy}+12)
                , z expr={\thisrow{Mean CaMKII}}
            ]{./data_fig_sync_camkii_6.csv};

        \addplot3 [ only marks, mark=*
            ] table [ col sep=comma
            , x expr={10^(\thisrow{Dpp1}+12)}
            , y expr={10^(\thisrow{Dxy}+12)}
                , z expr={\thisrow{is_bistable}==0?nan:1}
            ]{./data_fig_sync_camkii_6.csv};

    \end{loglogaxis}
    \node[ ] at (current bounding box.north west) {\bf \normalsize E};
\end{tikzpicture}
\end{tabular}
\end{document}

