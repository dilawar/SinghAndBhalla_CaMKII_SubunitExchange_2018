%%=====================================================================================
%%
%%       Filename:  synapse_signalling.tex
%%
%%    Description:  Signalling pathway in Synapse.
%%
%%        Version:  1.0
%%        Created:  04/30/2017
%%       Revision:  none
%%
%%         Author:  Dilawar Singh (), dilawars@ncbs.res.in
%%   Organization:  NCBS Bangalore
%%      Copyright:  Copyright (c) 2017, Dilawar Singh
%%
%%          Notes:  
%%                
%%=====================================================================================

\RequirePackage{luatex85}
\documentclass[crop,tikz]{standalone}
\usepackage{pgfplots}
\usetikzlibrary{calc,graphs,graphdrawing,fit,positioning}
\usetikzlibrary{decorations,decorations.footprints,decorations.shapes}
\usetikzlibrary{shapes,arrows,arrows.meta}
\usetikzlibrary{decorations.markings}
\usegdlibrary{layered}
\usepackage{xstring}
\pgfplotsset{compat=newest}

\input{macros.tex}
\input{channel.tex}
\input{actin.tex}

\newcommand\NMDA[1]{\CHANNEL{#1}{1}{0.8}{40}{red}}

\begin{document}

%\pgfmathsetseed{10}
\tikzset{
    -PO/.style = {
        decoration = { markings, 
            mark=at position -3pt with { 
                \node[draw,circle,fill=yellow,inner sep=1pt] {\tiny P}; }
        }, postaction = decorate, shorten >=3pt,
    }
}

\begin{tikzpicture}[scale=1, every node/.style={},% node distance=5mm 
    ]

    % Grid 
    %\draw[thin,step=1,gray!10] (-10,-10) grid (5,5);

    % Draw synapse.
    \edef\pdenda{(-8,-8)}
    \edef\pdendb{(-5,-8.2)}
    \edef\pnecka{(-3,-8)}
    \edef\pneckb{(-3,-4)}

    % Draw some actin.
    % First all the actin in dendrites.
    \foreach \i in {1,2,...,3}
    {
        \coordinate (start) at ([xshift=rnd,yshift=rnd](-8,-9));
        \coordinate (direcP) at ([xshift=rnd,yshift=rnd](0,-9));
        \pgfmathsetmacro\count{50+50*rnd}
        \ACTIN{a\i}{(start)}{(direcP)}{0.5pt}{\count};
    }


    \draw[color=blue,very thick] plot[smooth] coordinates { 
            \pdenda \pdendb \pnecka \pneckb (-7, -2) (-7,1) 
            (0, 1) (3,1) (2.5,-3) 
            (-1,-4) (-1,-8) (3,-8)
        };
    \node[ ] at (-5,-10) {Dendrite};


    \draw[blue,very thick] plot[smooth] coordinates { 
            (-8, -13) (-5, -13.5) (0,-13.1) (3, -13)
        };

    % draw PSD.
    \path[fill=blue!50,decorate,decoration={random steps}]
        (-6,1.2) -- (-5,1.2) -- (-4,1.2) -- (0,1.1) -- (3,1.2) 
        --  (1,0) -- (0,0) -- (-3,0) -- (-5,0) -- cycle;

    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % A lot of calcium outside  and calmodulin inside.
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    \foreach \i/\x/\y in {1/-7/2,2/-6.5/2.1,3/-6.2/1.9,4/-6.8/2.2}
    {
        \CA{ca\i}{(\x,\y)}{};
    }


    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Draw channels.
    % VDCC or voltage dependant calcium channel opens when membrane potential at
    % spine goes above threshold voltage of channel.
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    \coordinate (vdcc) at (-6,1);
    \node[draw=blue,rotate=110,cylinder,fill=white,label=VDCC,minimum height=7 mm] 
        at (vdcc) {};

    \node (n0) at (-5,1.2) { };
    \NMDA{n0}

    \node[above=of n0] {NMDA};
    \CA{canmda}{([yshift=-3mm]n0_c1)}{};
    \CA{canmda}{([yshift=-6mm]n0_c1)}{};

    % Another NMDA.
    \node (n1) at (1,1.2) { };
    \NMDA{n1};


    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Calcium inflow  
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    % Calcium can flow through VDCC
    \CA{ca0}{(vdcc)}{};
    \CA{ca1}{([yshift=-0.4cm]vdcc)}{};
    \CA{ca2}{([yshift=-1cm]vdcc)}{};

    \CACAM{cacam0}{-5.5,-0.5}{0.3}
    \CAM{cam0}{-6.5,0}{0.3}

    \draw[->,very thick] (cam0) to[midway] node (binding) {} (cacam0);
    \foreach \i in {1,2,...,5}
    {
        \coordinate (cacam) at (rnd*3-6,rnd-1)  {};
    }

    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % CaMKIIs.
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Attach a CaMKII below it.
    \CAMKII{camkiiPSD}{[xshift=-5mm]n1_c2.west}{1,2,3,4,5,6}{0.2}{6};
    
    \node[left=of n1,yshift=-5 mm,label=PP1,circle,fill=red] (pp1) {};
    \draw[-triangle 90 reversed] (pp1) edge[] (camkiiPSD);

    % CaMKII partial.
    \node[right=of cacam0,shift=(-30:5mm)] (camkii) {};
    \CAMKII{camkiiPartial}{camkii}{1,2,5}{0.2}{6}

    % CaMKII in spine neck.
    \node[shift=(-30:10mm)] (camkiineck) at \pneckb {};
    \CAMKII{camkiineck}{camkiineck}{}{0.2}{6}

    % A lot of camkii in dendritic shaft.
    \node[shift=(-90:10mm)] (camkiidend1) at \pdenda {};
    \foreach \i in {1,2,3,4,5}
    {
        \pgfmathsetmacro\theta{-20*rnd}
        \pgfmathsetmacro\r{rnd*10}
        \CAMKII{camkiineck}{[shift=(\theta:\r cm)]camkiidend1}{}{0.2}{6}
    }



    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Channels 
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    \node[below right=of cacam0] (can) {CaN};
    \node[below=of can] (i1p) {I1P/I2P};
    \node[above right=of i1p,xshift=5 mm] (ppx) {PP1/PP2};
    \node[left=of i1p,rotate=-90] (pka) {PKA};

     %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
     % Transportation of AMPA.
     %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    \draw[->,decorate,decoration={shape backgrounds,shape=dart,shape size=2 mm}] 
        (camkiiPartial) -- (camkiiPSD);

    \draw[-PO] (cacam0) to[ ] (can);
    \draw[-triangle 90 reversed] (can) edge[ ] (i1p);
    \draw[-triangle 90 reversed] (i1p) edge[ ] (ppx);
    \draw[-triangle 90 reversed] (pka) edge[ ] (i1p);
    
    % Phosphorylation
    \draw[-PO] (cacam0) to[ ] node[midway] (phospho) {} (camkiiPartial);
    \draw[-latex] (camkiiPartial.north) edge[out=90,in=120] (phospho);
    \draw[-triangle 90 reversed] (ppx) edge[] (camkiiPartial);
    \draw[-triangle 90 reversed] (cacam0) edge[bend right] (pka.west);

    %% Transportation of AMPA channels.
    \AMPA{a0}{(2.8,-2)}{1}{0.1}{10};
    \CAMKII{camkiiCyt1}{[shift=(135:2 cm)]a0}{1,2,3,4,5,6,7}{0.2}{7}
    \draw[-triangle 90 reversed] (ppx) edge[] (camkiiCyt1);

    % CaMKII help translocating AMPA channels via Ras/MaP-K. 
    \AMPA{a1}{(-2,0.8)}{1}{0.15}{90};

    % CaMKII phosphorylated AMPA thus increasing their conductance.
    \CAMKII{camkiiCyt2}{[shift=(0:5 mm)]n0_c2}{1,2,3,4,5,6,7}{0.2}{7}

    \node at ([yshift=10 mm]a1) {AMPA};
    \AMPA{a2}{(2.8,1)}{1}{0.1}{45};

    % Phosphorylates AMPA.
    \draw[-PO] (camkiiCyt2) to[bend right,right] ([shift=(-135:5mm)]a1);
        
    \draw[->,very thick
            ,decorate, decoration={footprints,foot length=10 pt,stride length=15pt}
            ] ($(a0)+(0.5,.5)$)  to[bend right] node[below,sloped,midway,yshift=-5 mm] (transport) 
            {\small MAPK} ([xshift=3mm]a2);

    \draw[-PO] (camkiiCyt1) -- (transport);

\end{tikzpicture}    

%\begin{tabular}{c c}
%    Molecule & size \\
%    CaMKII & 120 A \\
%    NMDA & 120 A  \\
%    ACTIN diameter & 50 A
%\end{tabular}

\end{document}
