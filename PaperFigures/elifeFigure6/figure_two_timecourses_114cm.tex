% ====================================================================================
%
%    Description:  Multiple bistables in PSD synchronized by subunit exchange.
%
%        Version:  1.0
%        Created:  Friday 12 January 2018
%       Revision:  none
%
%         Author:  Dilawar Singh (), dilawars@ncbs.res.in
%   Organization:  NCBS Bangalore
%      Copyright:  Copyright (c) 2018, Dilawar Singh
%
%          Notes:  
%
% ====================================================================================

\RequirePackage{luatex85,shellesc}
\documentclass[multi=false,class=../elife,varwidth=11.4cm]{standalone}
\usepackage{pgfplots}
\usepgfplotslibrary{fillbetween,units}
\usepackage{xstring}
\usepackage{xcolor}
\usepackage{siunitx}
\pgfplotsset{compat=1.15}
\renewcommand\familydefault{\sfdefault}
\usepackage{unicode-math}
\usetikzlibrary{calc,positioning}
\usetikzlibrary{shapes,arrows,arrows.meta,fit}

\newcommand\SUP[2]{#1\textsuperscript{#2}}

\begin{document}

\pgfmathsetmacro{\figW}{11.4}
\pgfmathsetmacro{\plotH}{3.5}

\pgfplotsset{
    , xtick align=center
    , ytick align=center
    , unit markings=parenthesis
    , legend style={fill=none,draw=none,font=\small}
    , tick label style={font=\small}
    , legend cell align={left}
    , axis lines*=left
}

\pgfplotsset{
    compat=1.15,
    legend image code/.code={
        \draw[mark repeat=2,mark phase=2]
        plot coordinates {
            (0cm,0cm)
            (0.15cm,0cm)        %% default is (0.3cm,0cm)
            (0.3cm,0cm)         %% default is (0.6cm,0cm)
        };%
    }
}

% {\bf On left} Calcium pulse is applied every \SI{500}{\sec} and decay
% profile is recorded. {\bf On right} Average decay profile with and without
% subunit-exchange. 

\begin{tikzpicture}[scale=1, every node/.style={} , node distance = 5mm ]
    \node[label={[xshift=5mm]north west:{\bf A}}] (plota) {
        \begin{tikzpicture}[scale=1,]
            \begin{axis}[ 
                xlabel=Time, x unit=\si{\second}
                , ylabel=\SUP{CaMKII}{*}
                , height=\plotH cm, width=0.75*\figW cm %, scale only axis
                , legend style={at={(0.9,1)},anchor=south east }
                , legend columns=-1
                , ytick={0,0.5,1.0}
                , xmin=10500, xmax=17500
                , enlarge x limits={abs=200}
                ]

                \addplot [red,thick,mark=o,mark size=0.5pt] gnuplot [ raw gnuplot ] {
                    plot "./CaM100_PP90000_voxels20_suOFF.dat_processed.dat" 
                    using "time":(column("CaMKII*")/100.0) 
                    every ::2000::3500
                };
                \addplot [blue,thick,mark=x,mark size=0.5pt] gnuplot [ raw gnuplot ] {
                    plot "./CaM100_PP90000_voxels20_suON.dat_processed.dat" 
                    using "time":(column("CaMKII*")/100.0) 
                    every ::2000::3500
                };

                % 24% of slow and 76% of fast.
                \addplot [black, very thick, no marks] gnuplot [ raw gnuplot ] {
                    plot "./CaM100_PP90000_voxels20_suONOFFCombined.dat" using
                    "time":((0.24*$2+0.76*$9)/100) 
                    every ::2000::3500
                };

                % 75% slow and 24% fast.
                \addplot [blue,thick,mark=x,mark size=1.2pt] gnuplot [ raw gnuplot ] {
                    plot "./CaM100_PP90000_voxels20_suON.dat_processed.dat" 
                        using "time":(column("CaMKII*")/100.0) 
                        every ::2000::3500
                };

                % Input ca.
                \addplot [black, thick, samples=2000
                    , domain=1000:5000, only marks
                    , mark=text, text mark=$\downarrow$ 
                ] gnuplot [raw gnuplot] {
                    f(x)=((x-1000*int(x/1000))==0)?1.15:0;
                    g(x)=((x-1000*int(x/1000))==0)?x:0;
                    plot "./CaM100_PP90000_voxels20_suON.dat_processed.dat" using (x=$1,g(x)):(x=$1,f(x))
                        every ::2000::3500
                };
                \legend{-SE,+SE,0.76(-SE)+0.24*(+SE)}
            \end{axis}
        \end{tikzpicture}
    };

    \node[below=3mm of plota.south west, anchor=north west
         , label={[xshift=5mm, yshift=-3mm]north west:{\bf B}} 
         ] (plotb) {
        \begin{tikzpicture}[scale=1]
            \begin{axis}[ xlabel=Time, x unit=\si{\second}
                % , ylabel=\SUP{CaMKII}{*}, y unit=frac
                , width=0.4*\figW cm, height=\plotH cm %, scale only axis
                , legend columns=2
                , ytick={0,0.5,1.0}
                , enlargelimits
                , legend style={at={(0,1)}, anchor=south west}
                ]
                \addplot [red] table [col sep=comma, x=time, y=decay_suOFF_mean]
                    {./data_camkii_state_decay.csv};
                \addplot [green, very thick] gnuplot  [ raw gnuplot ] {
                    set datafile separator ",";
                    A=0.5; tau=50;
                    f(x,A,tau)=A*exp(-x/tau);
                    fit f(x,A,tau) "./data_camkii_state_decay.csv" using
                        "time":"decay_suOFF_mean" via A, tau;
                    plot [x=0:1000] f(x,A,tau);
                };

                \addplot [red!30] gnuplot [raw gnuplot,name path=A] {
                    set datafile separator ",";
                    plot "./data_camkii_state_decay.csv" 
                        using "time":(column("decay_suOFF_mean")-column("decay_suOFF_std"))
                };
                \addplot [red!30] gnuplot [raw gnuplot, name path=B] {
                    set datafile separator ",";
                    plot "./data_camkii_state_decay.csv" 
                        using "time":(column("decay_suOFF_mean")+column("decay_suOFF_std"))
                };
                \addplot [red!30] fill between [of=A and B];

                % With SE plot.
                \addplot [blue] table [col sep=comma,x=time, y=decay_suON_mean] 
                     {./data_camkii_state_decay.csv};

                \addplot [blue,dotted, very thick] gnuplot  [ raw gnuplot ] {
                    set datafile separator ",";
                    f(x,tauA)=exp(-x/(tauA));
                    fit f(x,tauA) "./data_camkii_state_decay.csv" using
                        "time":"decay_suON_mean":"decay_suON_std" yerrors via tauA;
                    plot [x=0:800] f(x,tauA);
                };

                % shadowed area to represent std.
                \addplot [blue!30] gnuplot [raw gnuplot,name path=A] {
                    set datafile separator ",";
                    plot "./data_camkii_state_decay.csv" 
                        using "time":(column("decay_suON_mean")-column("decay_suON_std"))
                };
                \addplot [blue!30] gnuplot [raw gnuplot, name path=B] {
                    set datafile separator ",";
                    plot "./data_camkii_state_decay.csv" 
                        using "time":(column("decay_suON_mean")+column("decay_suON_std"))
                };

                \addplot [blue!30] fill between [of=A and B];
                \legend{-SE,-SE (exp-fit),,,,+SE,+SE (exp-fit),,}
            \end{axis}
        \end{tikzpicture}
    };

    \node[right=3mm of plotb.north east, anchor=north west
         , label={[xshift=5mm, yshift=-2mm]north west:{\bf C}} 
         ] (plotc) {
        \begin{tikzpicture}[scale=1]
            \begin{axis}[ xlabel=Time, x unit=\si{\second}
                % , ylabel=\SUP{CaMKII}{*}, y unit=frac
                , width=0.4*\figW cm, height=\plotH cm %, scale only axis
                , legend columns=1
                , ytick={0,0.5,1.0}
                , enlargelimits
                , legend style={at={(0,1)}, anchor=south west}
                ]

                \addplot [blue, thick] gnuplot [raw gnuplot,name path=A] {
                    set datafile separator ",";
                    plot "./data_camkii_state_decay.csv" 
                        using "time":(0.76*column("decay_suOFF_mean")+0.24*column("decay_suON_mean"))
                        ;
                };

                % shadowed area to represent std.
                \addplot [blue!30] gnuplot [raw gnuplot,name path=A] {
                    set datafile separator ",";
                    plot "./data_camkii_state_decay.csv" 
                        using "time":(0.76*column("decay_suOFF_mean")+0.24*column("decay_suON_mean")-
                        (0.76*column("decay_suOFF_std")^2+0.24*column("decay_suON_std")^2)^0.5);
                };

                \addplot [blue!30] gnuplot [raw gnuplot, name path=B] {
                    set datafile separator ",";
                    plot "./data_camkii_state_decay.csv" 
                        using "time":(0.76*column("decay_suOFF_mean")+0.24*column("decay_suON_mean")+
                        (0.76*column("decay_suOFF_std")^2+0.24*column("decay_suON_std")^2)^0.5);
                };

                \addplot [blue!30] fill between [of=A and B];

                % fit by two time courses.
                \addplot [red, dashed, very thick] gnuplot  [ raw gnuplot ] {
                    set datafile separator ",";
                    f(x)=0.76*exp(-x/tauA)+0.24*exp(-x/tauB);
                    fit f(x) "./data_camkii_state_decay.csv" using
                    "time":(0.76*column("decay_suOFF_mean")+0.24*column("decay_suON_mean")) via tauA, tauB;
                    plot [x=0:800] f(x);
                };
                \legend{0.76*fast+0.24*slow,$0.76e^{-t/4.99}+0.24e^{-t/118.18}$ (fit)}
            \end{axis}
        \end{tikzpicture}
    };

\end{tikzpicture}	

\end{document}
